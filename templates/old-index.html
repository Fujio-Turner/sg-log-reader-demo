<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Sync Gateway Log Reader GUI</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <!--
	/* 
         <script src="assets/vis.min.js" type="text/javascript"></script>
          <link href="assets/vis.min.css" rel="stylesheet" type="text/css"/> 
        */
	-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.20.1/vis.min.js" type="text/javascript"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.20.1/vis.min.css" rel="stylesheet" type="text/css"/>  

<style>
.container {
    width: 90%;
    height: 50px;
    margin: auto;
    padding: 10px;
}
.one {
    height: 40px;
    float: left;
    padding: 5px;
}

.css_btn_class {
  font-size:16px;
  font-family:Arial;
  font-weight:normal;
  -moz-border-radius:8px;
  -webkit-border-radius:8px;
  border-radius:8px;
  border:1px solid #dcdcdc;
  padding:6px 11px;
  text-decoration:none;
  background:-moz-linear-gradient( center top, #ededed 5%, #dfdfdf 100% );
  background:-ms-linear-gradient( top, #ededed 5%, #dfdfdf 100% );
  filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ededed', endColorstr='#dfdfdf');
  background:-webkit-gradient( linear, left top, left bottom, color-stop(5%, #ededed), color-stop(100%, #dfdfdf) );
  background-color:#ededed;
  color:#777777;
  display:inline-block;
  text-shadow:1px 1px 0px #ffffff;
  -webkit-box-shadow:inset 1px 1px 0px 0px #ffffff;
  -moz-box-shadow:inset 1px 1px 0px 0px #ffffff;
  box-shadow:inset 1px 1px 0px 0px #ffffff;
}.css_btn_class:hover {
  background:-moz-linear-gradient( center top, #dfdfdf 5%, #ededed 100% );
  background:-ms-linear-gradient( top, #dfdfdf 5%, #ededed 100% );
  filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#dfdfdf', endColorstr='#ededed');
  background:-webkit-gradient( linear, left top, left bottom, color-stop(5%, #dfdfdf), color-stop(100%, #ededed) );
  background-color:#dfdfdf;
}.css_btn_class:active {
  position:relative;
  top:1px;
}
/* This css button was generated by css-button-generator.com */
</style>

        
        <script type="text/javascript">

var items = [];
var fakeItems = [];
var graphNames = [];

function bear(){   
        
        
 if(typeof graph2d !== 'undefined'){
     graph2d.destroy();
     graph2d = null;
 }
        
document.getElementById('visualization').innerHTML = "";

var data = JSON.parse(document.getElementById("data-dump").value); 

var graphShow  = graph.graphType.value;
var valueShow  = graph.showValue.value;
var valueTimes = graph.showTimes.value;
var graphAxis  = graph.graphAxis.value;
        
        var httpList = [];
        var counter = 0;
        for (var i in data["HTTP"]){
            
          if (i !== "times"){
            httpList.push([i,data["HTTP"][i]]);
            
                for(var h in data["HTTP"][i]){
                    //console.log(data["HTTP"][i][h]["times"]);
                    
                    for(var j in data["HTTP"][i][h]["times"]){
                        
                     //data["HTTP"][i][h]["times"][j]
                     //console.log(j)
                     //console.log(data["HTTP"][i][h]["times"][j]["amount"]) 
                     
                        if(graphShow === 'min'){
                            if(valueShow === 'show'){
                                
                                cString = data["HTTP"][i][h]["times"][j]["num"];
                                
                                if ("d" in data["HTTP"][i][h]["times"][j]){
                                        cString = cString + " ("+data["HTTP"][i][h]["times"][j]["d"].slice(0,-7)+")";
                                        items.push({x:j,y:data["HTTP"][i][h]["times"][j]["num"],group:counter,label:{content:cString}});
                                          
                                }else{
                                    items.push({x:j,y:data["HTTP"][i][h]["times"][j]["num"],group:counter,label:{content:cString}});
                                }
                            }else{
                                items.push({x:j,y:data["HTTP"][i][h]["times"][j]["num"],group:counter});
                            }
                        continue;
                        }
                     
                            for(var k in data["HTTP"][i][h]["times"][j]){

                                if(k === "times"){
                                //console.log(data["HTTP"][i][h]["times"][j][k])

                                for(var l in data["HTTP"][i][h]["times"][j][k]){
                                 //console.log(data["HTTP"][i][h]["times"][j][k][l])

                                   if(valueShow === 'show'){
                                       cString = data["HTTP"][i][h]["times"][j][k][l]["num"];

                                          if(valueTimes === 'show'){
                                            if ("d" in data["HTTP"][i][h]["times"][j][k][l] ){
                                                 //cString = cString + " ("+data["HTTP"][i][h]["times"][j][k][l]["d"].slice(3)+")";
                                              
                                                if(graphAxis === "slow"){
                                                  cString = cString + " total";
                                                  
                                                  
                                                  console.log(data["HTTP"][i][h]["times"][j][k][l]["d"].slice(3))
                                                 items.push({x:l,y:data["HTTP"][i][h]["times"][j][k][l]["d"].slice(3),group:counter,label:{content:cString}});
         
                                                }else{
                                                 cString = cString + " ("+data["HTTP"][i][h]["times"][j][k][l]["d"].slice(3)+")";
                                                 items.push({x:l,y:data["HTTP"][i][h]["times"][j][k][l]["num"],group:counter,label:{content:cString}});
                                                }
                                                 
                                            }else{
                                                 items.push({x:l,y:data["HTTP"][i][h]["times"][j][k][l]["num"],group:counter,label:{content:'n/a'}});
                                             }
                                          }else{
                                              items.push({x:l,y:data["HTTP"][i][h]["times"][j][k][l]["num"],group:counter,label:{content:cString}});
                                          }

                                   }else{
                                       items.push({x:l,y:data["HTTP"][i][h]["times"][j][k][l]["num"],group:counter});
                                    }
                                   }
                                }
                             }
          
                        
                     //fakeItems.push({x:j,y:data["HTTP"][i][h]["times"][j]["amount"],group:counter,label:{content:data["HTTP"][i][h]["times"][j]["amount"]}});  
                    }
                     graphNames.push(i+":"+h);
                    counter += 1;  
                }
            }
        }      
 //console.log(items);
 myFunction(items);
}

function checkDataType(dType=''){
    var opt = {"line":"stroke-dasharray:1 0;","point":"circle","color":false,"fill":false};
    if(dType.includes("POST:") || dType.includes("PUT:")){
        opt["line"] = "stroke-dasharray:10 5 2 5;";
    /*
       switch(dType) {
        case "POST:_changes":
            opt["color"] = "orange";
            opt["fill"]="orange";
            break;
        case "POST:_bulk_docs":
            opt["color"] = "purple";
            break;
        }
        */
        }
    if(dType.includes("POST:_bulk_get")){
        opt["line"] = "stroke-dasharray:1 0;"; 
        //opt["color"] = "green"; 
    } //Bulk_get back to solide
    
    if(dType.includes("ADMIN:")){ opt["point"] = "square"; opt["line"] = "stroke-dasharray:2 2;";}
    if(dType.includes("DELETE")){ opt["color"] = "red"; opt["fill"]="red"; opt["line"] = "stroke-dasharray:2 2;";}
    return opt;
}

    
 function myFunction(items){ 
     
 
 var container = document.getElementById('visualization');
 var dataset = new vis.DataSet(items);    
 var groups = new vis.DataSet();
 var graphAxis  = graph.graphAxis.value;
    
    for(var x in graphNames){
                  
       var yup = checkDataType(graphNames[x]);
        var gStyle = 'stroke-width:2;'; 
        var sti = 'circle';
        
        if(yup["line"] !== false){gStyle = gStyle +yup["line"];}
        if(yup["color"] !== false){gStyle = gStyle + "stroke:"+yup["color"]+";fill:"+yup["color"]+";"};
        if(yup["point"] !== false){sti = yup["point"];};
   
       groups.add({
        id: x,
        content: graphNames[x],
        style:gStyle,
        options: {
            drawPoints: {style: sti},
            shaded: {orientation: 'bottom'}
        }});   
    }
    
  var yAxisTitle = "Number per (min or sec)"  
  if(graphAxis === "slow"){ yAxisTitle = "Slowest Response Time per HTTP call";}
    
  var options = {    
   legend:true,
   moveable:true,
   zoomable:true,
   zoomMin:1000,
   zoomMax:1000000000,
   height:700,
   dataAxis: {
            showMinorLabels: true,
            left: {
                title: {text: yAxisTitle}
            }
        }
  };

graph2d = new vis.Graph2d(container, dataset, groups,options);
 } 

</script>
</head>
<body>        
<div  id="visualization"></div>
<div class="container">
<div class="one">
<textarea id="data-dump" placeholder="Paste SG-Log-Reader JSON here" rows="3" cols="30"></textarea>
</div>
<form id="graph">
  <div class="one">
  Graph X-axis
  <br />
  <input type="radio" name="graphType" value="min" >Per Minute
  <input type="radio" name="graphType" value="sec" checked="checked">Per Second<br>
  </div>
   <div class="one">
  Graph Y-axis
  <br />
  <input type="radio" name="graphAxis" value="slow" >Slowest Response
  <input type="radio" name="graphAxis" value="totol" checked="checked">Total Response<br>
  </div>
  <div class="one">
  Show Data Values on Graph
  <br />
  <input type="radio" name="showValue" value="hide" >Hide
  <input type="radio" name="showValue" value="show" checked="checked">Show 
  </div>
  <div class="one">
   Peak response(seconds) for a given time & process
  <br />
  <input type="radio" name="showTimes" value="hide" >Hide
  <input type="radio" name="showTimes" value="show" checked="checked">Show<br>
</div>
<div class="one">
<input class="css_btn_class" type="button" value="Make Graph" id="make-graph" onclick="bear()">
</div>
</div>
</form>
</body>
</html>
