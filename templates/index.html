<!DOCTYPE html>
<html>
    <head>
        <title>Sync Gateway Log Reader GUI</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="{{ url_for('static', filename='assets/daterangepicker.css') }}">
<style>
canvas {
      -moz-user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }

.intInput{
  width: 80px;
}

.search{
}

.sgList {
  overflow: scroll;
}

#sgDbList{
  height: 200px;
  width: 200px;
}

#sgUserList{
  height: 300px;
}

.sgListData
{
width: 160px;
padding: 10px;
border: 2px solid #9294f6;
border-radius: 15px;
-moz-border-radius: 15px;
}

/* DivTable.com */
.divTable{
	display: table;
	width: 100%;
}
.divTableRow {
	display: table-row;
}
.divTableHeading {
	background-color: #EEE;
	display: table-header-group;
}
.divTableCell, .divTableHead {
	border: 1px solid #999999;
	display: table-cell;
	padding: 3px 10px;
}
.divTableHeading {
	background-color: #EEE;
	display: table-header-group;
	font-weight: bold;
}
.divTableFoot {
	background-color: #EEE;
	display: table-footer-group;
	font-weight: bold;
}
.divTableBody {
	display: table-row-group;
}

.userDetailList{
  border-radius: 6px; 
  border: 2px solid #d7d7d7;
  padding:0.5em;
  margin-bottom: 2px;
}

.userSyncStats{
  height: 400px;
  overflow: scroll;
}



.wsIdDetailRow {

}

.ws-dark {
        background-color: #dddbdb;
    }
.ws-light {

    }

  #chart1 {
    display: inline-block;
    position: relative;
    width: 100%;
    height: 600px;
  }

  #chart2 {
    display: inline-block;
    position: relative;
    width: 100%;
    height: 600px;
  }

</style>
</head>
<body>        

 

<div class="divTable">
  <div class="divTableBody">
  <div class="divTableRow">
      <div class="divTableCell">
        
          <div class="one" id="datepicker">
          <input type="text" id="dtFrom" name="dtFrom" placeholder="Start Date" value="">
          </br>
          <input type="text" id="dtTo" name="dtTo" placeholder="End Date" value="">
          </div>

      </div>
      <div class="divTableCell">
        
          <div class="one" id="search">
          <input class="searchInput" type="text" id="searchByUser" name="searchByUser" placeholder="User Name (Optional)">
          <button id="search" class="search">Search</button>
          </div>

      </div>
  </div>
  <div class="divTableRow">
      <div class="divTableCell">
        
          <div id="sgDbList" class="sgList">
            <select id="sgDbListOptions"></select>
          </div>

      </div>
      <div class="divTableCell">
       
          <div class="one" id="filterBy">
            <label for="syncResult">Sync Result:</label>
            <select name="syncResult" id="syncResult">
              <option value="any" selected="selected">Any Result</option>
              <option value="full">All Docs/Full Sync</option>
              <option value="nonFull">Missing Docs/No Sync</option>
            </select>
          <label for="changeCount">Changes Feed Items(Total):</label><input class="intInput" type="text" id="changeCount" name="changeCount" placeholder="0 or Greater(INT)" >
          <label for="syncTime">Time Connected (sec):</label><input class="intInput" type="text" id="syncTime" name="syncTime" placeholder="In Seconds(INT)" >
          <input type="checkbox" id="sinceZero" name="sinceZero" ><label for="sinceZero">Since Zero</label> 
          <input type="checkbox" id="filterByChannels" name="filterByChannels" ><label for="filterByChannels">User Filtered By Channels</label>
          <input type="checkbox" id="conflicts" name="conflicts" ><label for="conflicts">Has Conflicts</label>
          <input type="checkbox" id="errors" name="errors" ><label for="errors">Has Errors</label>
          <button id="resetFilters" class="reset">Reset Filters</button>
          </div>

      </div>
  </div>
  <div class="divTableRow"  ">
      <div class="divTableCell">

          <div  id="sgUserList" class="sgList"></div>

      </div>
      <div class="divTableCell">
        
          <div id="chart1">
            <canvas id="myChart1"></canvas>
          </div>

      </div>
  </div>
  <div class="divTableRow" >

      <div class="divTableCell">

            Sort By:
            <input type="radio" id="userName" name="userSort" value="name" checked="checked" >
            <label for="userName">Name</label>
            <input type="radio" id="userCount" name="userSort" value="count">
            <label for="userCount">Count</label>

      </div>
      <div class="divTableCell">

        <div id="chart2">
              <canvas  id="myChart2"></canvas>
        </div>
        
      </div>
  </div>
  <div class="divTableRow">
      <div class="divTableCell">
        
              &nbsp;

      </div>
      <div class="divTableCell">
          
            <div id="stats">
              <label for="resultSize">Number of Results:</label><span id="resultSize" name="ResultSize" ></span>
              <div id="chart3" style="display: inline-block">
                    <canvas width="250" height="250" id="myChart3"></canvas>
              </div>
              <div id="chart4" style="display: inline-block">
                    <canvas width="250" height="250" id="myChart4"></canvas>
              </div>
              <div id="chart5" style="display: inline-block">
                <canvas width="250" height="250" id="myChart5"></canvas>
          </div>
            </div>

      </div>
  </div>
  <div class="divTableRow">
      <div class="divTableCell">

            &nbsp;

      </div>
      <div class="divTableCell">

            <div class = "userSyncStats" id="userSyncStats"></div>

      </div>
  </div>
  </div>
  </div>
  <!-- DivTable.com -->


<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="{{ url_for('static', filename='assets/jquery.daterangepicker.js') }}"></script>
<script src="{{ url_for('static', filename='assets/notify.min.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>


<script type="text/javascript">

sgName = ""

$('#dtFrom').on('input',function(e){

  var from = $('#dtFrom').val();
    var to = $('#dtTo').val();
    if(from === "" || to === ""){
      $.notify("Pick a Date Range");
      return;
    }
    if(sgName === ""){
      sgDbListGet();
    }
});


$('#dtTo').on('input',function(e){

   var from = $('#dtFrom').val();
    var to = $('#dtTo').val();
    if(from === "" || to === ""){
      $.notify("Pick a Date Range");
      return;
    }

    if(sgName === ""){
      sgDbListGet();
    }
});


$('#sgDbListOptions').on('input',function(e){
  sgName = $('#sgDbListOptions').val();
});


$('input[type=radio][name=userSort]').change(function() {
    sgUserList()
});

  $("#resetFilters").click(function(e){
    $("#syncResult").val('any');
    $("#changeCount").val("");
    $("#syncTime").val("");
    $("#sinceZero").prop('checked', false);
    $("#errors").prop('checked', false);
    $("#conflicts").prop('checked', false);
    $("#filterByChannels").slideToggle();
  });

  $("#search").click(function(e){
    sgUserList()
    bigSearch()
  });

$(document).ready(function(){

getSampleDt()

dtConfig = {
  format:'YYYY-MM-DDTHH:mm:ss',
  time: {
		enabled: true
	},
  showShortcuts: true,
  customShortcuts: 
	[
  {
			name: 'last 24hr',
			dates : function()
			{
				var start = moment().day(0).toDate();
				var end = moment().day(1).toDate();
				return [start,end];
			}
		},
		{
			name: 'this week',
			dates : function()
			{
				var start = moment().day(0).toDate();
				var end = moment().day(6).toDate();
				return [start,end];
			}
		}
	],
  separator : ' to ',
	getValue: function()
	{
		if ($('#dtFrom').val() && $('#dtTo').val() )
			return $('#dtFrom').val() + ' to ' + $('#dtTo').val();
		else
			return '';
	},
	setValue: function(s,s1,s2)
	{
		$('#dtFrom').val(s1);
		$('#dtTo').val(s2);
	}

}

$('#dtFrom').dateRangePicker(dtConfig);
$('#dtTo').dateRangePicker(dtConfig);

});


function sgDbListGet(){
  $('#sgDbListOptions').empty()
  var data1 = {}
  data1['startDt'] = $('#dtFrom').val();
  data1['endDt'] = $('#dtTo').val();

    $.ajax({
      type: 'POST',
      url: '/sgDbList',
      data: JSON.stringify(data1),
      dataType: 'json',
      contentType:'application/json; charset=utf-8',
      success: function(data2) { 
        
        $.each(data2, function(key, value) {       
            if(key === 0){
              var html = '<option value="'+value.sgDb+'" selected>'+value.sgDb+'</option>';
              sgName = value.sgDb
            }else{
              var html = '<option value="'+value.sgDb+'" >'+value.sgDb+'</option>';              
            }              
            $("#sgDbListOptions").append(html)
          });
          $.notify("Find SG DBs","success");
      }
  });
}


function sgUserList(){
  $('#sgUserList').empty()
  var data1 = {}
  data1["sgDb"] = $('#sgDbListOptions').val()
  data1['startDt'] = $('#dtFrom').val();
  data1['endDt'] = $('#dtTo').val();
  data1['sortBy'] = $('input[name="userSort"]:checked').val();

  data1["syncResult"] = $("#syncResult").val();
  data1["changeCount"] = $('#changeCount').val()
  data1["syncTime"] = $('#syncTime').val()
  data1["filterByChannels"] = $('#filterByChannels').is(":checked");
  data1["conflicts"] = $('#conflicts').is(":checked");
  data1["sinceZero"] = $('#sinceZero').is(":checked");
  data1["errors"] = $('#errors').is(":checked");


  $.ajax({
    type: 'POST',
    url: '/sgUserList',
    data: JSON.stringify(data1),
    dataType: 'json',
    contentType:'application/json; charset=utf-8',
    success: function(data2) { 
          $.each(data2, function(key, value) {

            var c = "dark"
          if(key % 2 == 0) {
            c = "light"
            }

            var html = '<div class="ws-'+c+'"><a href="#sgUser=' + value.user + '"  onclick="userFill(\''+value.user+'\')"  >' +value.user+ ' ('+value.sgUserCount+')</a></div>'
          $('#sgUserList').append(html)
        });
        }
    });
  }

  function bigSearch(){


    var from = $('#dtFrom').val();
    var to = $('#dtTo').val();
    if(from ==="" && to === ""){
      $.notify("Pick a Date Range");
      return
    }

    if(sgName === ""){
      $.notify("Pick a SG DB");
      return
    }

    var data1 = {}
    data1["sgDb"] = $('#sgDbListOptions').val()
    data1['startDt'] = from
    data1['endDt'] = to
    data1["user"] = $('#searchByUser').val()
    data1["syncResult"] = $("#syncResult").val();
    data1["changeCount"] = $('#changeCount').val()
    data1["syncTime"] = $('#syncTime').val()
    data1["filterByChannels"] = $('#filterByChannels').is(":checked");
    data1["conflicts"] = $('#conflicts').is(":checked");
    data1["sinceZero"] = $('#sinceZero').is(":checked");
    data1["errors"] = $('#errors').is(":checked");

      $.ajax({
        type: 'POST',
        url: '/dateRange',
        data: JSON.stringify(data1),
        dataType: 'json',
        contentType:'application/json; charset=utf-8',
        success: function(data2) { 
          makeChart(data2)
        }
    });
}




function makeChart(data){

  if(typeof c1 !== 'undefined' || typeof c2 !== 'undefined' || typeof c3 !== 'undefined'|| typeof c4 !== 'undefined' || typeof c5 !== 'undefined'){
         c1.destroy(); c2.destroy(); c3.destroy(); c4.destroy(); c5.destroy(); 
        }
   $('#resultSize').html('');
 const ctx1 = document.getElementById('myChart1');
 const ctx2 = document.getElementById('myChart2');
 const ctx3 = document.getElementById('myChart3');
 const ctx4 = document.getElementById('myChart4');
 const ctx5 = document.getElementById('myChart5');

  var valuesChangesCache = [];
  var valuesChangesQuery = [];
  var valuesSyncTime = [];
  var valuesErrors = [];
  var valuesConflicts = [];
  var labelsJ = [];
  var cbwsId = []
  var valuesSent = []
  var valuesChangesSent = []
  var valuesSentVsChangesSent = []
  var userSyncAllTrue = 0
  var userSyncAllFalse = 0
  var sinceZeroTrue = 0
  var sinceZeroFalse = 0
  var channelCache = 0
  var channelQuery = 0
  var resultShow = 0


  if($('#searchByUser').val() !== ""){
    makeUserDetails(data)
  }
console.log(data)

  $.each(data, function(key, value) {   

    
    resultShow = resultShow + 1    
    valuesErrors.push(value.errors)
    valuesChangesCache.push(value.cRow)
    valuesChangesQuery.push(value.qRow)
    valuesSyncTime.push(value.dtDiffSec)
    valuesConflicts.push(value.conflicts)
    valuesSent.push(value.sentCount)
    valuesChangesSent.push(value.tRow)
    valuesSentVsChangesSent.push(value.sent/value.tRow)
    labelsJ.push(value.dt) 

      if(typeof value.cRow !== 'undefined'){
        channelCache = channelCache + value.cRow
      } 

      if(typeof value.qRow !== 'undefined'){
      channelQuery = channelQuery + value.qRow  
      } 

    if(value.tRow == value.sentCount){
      userSyncAllTrue = userSyncAllTrue + 1
    }else{
      userSyncAllFalse = userSyncAllFalse + 1
    }

    if( value.since == '0' || value.since == 0){
      sinceZeroTrue =  sinceZeroTrue + 1
    } else{
      sinceZeroFalse =  sinceZeroFalse + 1
    }
  });

  c1 = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: labelsJ,
      datasets: [  
        
      {
        label: 'Docs Sent',
        data: valuesSent,
        borderWidth: 1
      }, 
      {
        label: 'Errors In Sync',
        data: valuesErrors,
        borderWidth: 1
      },
      {
        label: 'Changes Sent (_changes)',
        data: valuesChangesSent,
        borderWidth: 1
      },
      {
        label: 'Conflicts in Sync',
        data: valuesConflicts,
        borderWidth: 1
      }
    ]
    },
    options: {
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          type: 'logarithmic'
        }, 
        x :{

          
        }
      }
    }
  });


  c2 = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: labelsJ,
      datasets: [
      {
        label: 'Changes Feed (By SG\'s Cache)',
        data: valuesChangesCache,
        borderWidth: 1,
        type:'bar',
        borderColor: '#00CF9B',
        backgroundColor: '#00CF9B'
      },
      {
        label: 'Changes Feed (By SQL++ Query)',
        data: valuesChangesQuery,
        borderWidth: 1,
        type: 'bar',
        borderColor: '#cc33ff',
        backgroundColor: '#cc33ff'
      }


    ]
    },
    options: {
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          stacked: true
        },
        x: {
          stacked: true
        }
      }
    }
  });


  const optionsPie1 = {
    tooltips:{
                  enabled: true
                },
    responsive: true,
   maintainAspectRatio: false,
    plugins: { 
       title: {
               display: true,
              text: 'Changes Sent (`_changes`) VS Total Docs Sent (JSON)'
              },
      legend: {
        position: 'top'
      },
      datalabels: {
        display: 'auto',
        color: 'black',
        font: {
          weight: 'bold'
        },
        formatter: (value, ctx3) => {
          const total = ctx3.chart.getDatasetMeta(0).total;
          let percentage = (value * 100 / total).toFixed(0) + "%";
          return percentage + ' (' + value + ')';
        },
      }
    }
  }


 c3 = new Chart(ctx3, {
    type: 'pie',
    data: {
      labels: ['All Docs Synced',"Missing Docs or No Sync"],
      datasets: [
                {
                  data:[userSyncAllTrue,userSyncAllFalse],
                  backgroundColor: [
                                    '#00CF9B',
                                    '#E55B5E'
                                    ]
                }
                ]
    },
    options: optionsPie1,
    plugins:[ChartDataLabels]
      });




    const optionsPie2 = {
    tooltips:{
                  enabled: true
                },
    responsive: true,
   maintainAspectRatio: false,
    plugins: { 
       title: {
               display: true,
              text: 'Start from Zero (new) VS Old Sync'
              },
      legend: {
        position: 'top'
      },
      datalabels: {
        display: 'auto',
        color: 'black',
        font: {
          weight: 'bold'
        },
        formatter: (value, ctx4) => {
          const total = ctx4.chart.getDatasetMeta(0).total;
          let percentage = (value * 100 / total).toFixed(0) + "%";
          return percentage + ' (' + value + ')';
        },
      }
    }
  }

      c4 = new Chart(ctx4, {
    type: 'pie',
    data: {
      labels: ["New Sync (since=0)","Old Sync"],
      datasets: [
                  {
                    data:[sinceZeroTrue,sinceZeroFalse],
                    backgroundColor: [
                                      '#3366ff',
                                      '#ff9900'
                                      ]
                  }
                ]
    },
    options: optionsPie2,
    plugins:[ChartDataLabels]
      });



    const optionsPie3 = {
    tooltips:{
                  enabled: true
                },
    responsive: true,
   maintainAspectRatio: false,
    plugins: { 
       title: {
               display: true,
              text: 'Cache Hit VS SQL++ Query for Channels'
              },
      legend: {
        position: 'top'
      },
      datalabels: {
        display: 'auto',
        color: 'black',
        font: {
          weight: 'bold'
        },
        formatter: (value, ctx5) => {
          const total = ctx5.chart.getDatasetMeta(0).total;
          let percentage = (value * 100 / total).toFixed(0) + "%";
          return percentage;
        },
      }
    }
  }


      c5 = new Chart(ctx5, {
    type: 'pie',
    data: {
      labels: ["Cache Hit","SQL++ Query"],
      datasets: [
                  {
                    data:[channelCache,channelQuery],
                    backgroundColor: [
                                      '#00CF9B',
                                      '#cc33ff'
                                      ]
                  }
                ]
    },
    options: optionsPie3,
    plugins:[ChartDataLabels]
      });

      $('#resultSize').html(resultShow.toLocaleString());

    }


  function makeUserDetails(data){
    $('#userSyncStats').empty();

      $.each(data, function(key, value) {  

        
        var html = '<div class="userDetailList" onclick="userSyncDetails(\''+value.cbKey+'\')" <b>'+value.dt +"</b>"
          html = html + ' <b>wsId:</b> ' +value.cbKey;
          html = html + ' <b>Connect Time(sec):</b> ' +value.dtDiffSec + " ";

          var r = ""
          if (value.tRow > 0){
          r = (value.cRow/value.tRow) * 100
          var r = r.toFixed(1)
          }
      
          html = html + ' <b>Changes Sent(Total):</b> ' +value.tRow 

          if(value.tRow === value.sentCount){
            html = html + ' <b>Docs Sent(Total):</b> ' +value.sentCount;
          }else{
            html = html + ' <b>Docs Sent(Total):</b> <span style="color: orange;">' +value.sentCount+"</span>";
          }

          html = html + ' <b>Channel Cache Hit:</b> ' + r + "% "
          if(value.blipC === true){
          html = html + ' <b>Sync Closed(blip ended):</b> <span style="color: green;">Yes</span>';
          }else{
          html = html + ' <b>Sync Closed(blip ended):</b> <span style="color: orange;">No</span>';
          }

          if(value.conflicts > 0){
            html = html + ' <b>Conflicts:</b> <span style="color: orange;">' +value.conflicts+"</span>";
          }else{
            html = html + ' <b>Conflicts:</b> ' +value.conflicts;
          }
          
          if(value.errors > 0){
            html = html + ' <b>Errors:</b> <span style="color: red;">' +value.errors+"</span>";
          }else{
            html = html + ' <b>Errors:</b> ' +value.errors;
          }
         html = html + '</div></br><div class="wsIdDetailRow" id="wsIdDetails-'+value.cbKey+'"></div>';
        $('#userSyncStats').append(html) ;    
       });
  }
  
function userFill(username){
  $('#searchByUser').val(username);
}

function userSyncDetails(wsId){

  $('#wsIdDetails-'+wsId).empty();
  data1 = {'wsId':wsId}

  $.ajax({
    type: 'POST',
    url: '/wsId',
    data: JSON.stringify(data1),
    dataType: 'json',
    contentType:'application/json; charset=utf-8',
    success: function(data2) { 
          var html = ''
          html = html + ' <b>Connection Start:</b> '+ data2['dt']+' <b>End:</b> ' + data2["dtEnd"] + ' <b>Connection Time(sec):</b> '+ data2['dtDiffSec']+'</br>'
          html = html + '  <b>Filtered By Channel(s):</b> ' + data2["filterBy"] + ' </br>'
          html = html + '  <b>Since:</b> ' + data2["since"] + ' </br>'
          html = html + wsIdMakeHtml(data2["log"])
          $('#wsIdDetails-'+wsId).html(html)
        }
    });
  }


function wsIdMakeHtml(data){
  var html = '<b>Raw Sync Log</b> </br>'
  $.each(data, function(key, value) {

    var c = "dark"
    if(key % 2 == 0) {
      c = "light"
      }
    html = html + '<div class="ws-'+c+'" >'+ value + '</div>'
    });
  return html
}

function getSampleDt(){

  $.ajax({
        url: "/lastWsId",
        type: 'GET',
        dataType: 'json', // added data type
        success: function(data) {
            
            const dateString = data[0]['dt'];
            const date = new Date(dateString);
            date.setHours(date.getHours() - 6);

          $('#dtFrom').val( date.toISOString().substr(0,19));
          $('#dtTo').val(data[0]['dt']);
          sgDbListGet();

        }
    });


}
</script>  
</body>
</html>